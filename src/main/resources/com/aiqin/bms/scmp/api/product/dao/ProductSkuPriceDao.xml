<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiqin.bms.scmp.api.product.dao.ProductSkuPriceDao">
  <insert id="insertDraftList" parameterType="java.util.List" >
    insert into product_sku_price_draft (add_points_value, gross_profit_margin_value,
    del_flag, create_time, create_by,
    update_time, update_by, price_type_code,
    price_type_name, price_value, effective_time,
    stop_time, sku_code, sku_name,
    supplier_code, supplier_name)
    values
    <foreach collection="list" item="item" index="index" separator=",">
      (#{item.addPointsValue,jdbcType=BIGINT}, #{item.grossProfitMarginValue,jdbcType=BIGINT},
      #{item.delFlag,jdbcType=TINYINT}, #{item.createTime,jdbcType=TIMESTAMP}, #{item.createBy,jdbcType=VARCHAR},
      #{item.updateTime,jdbcType=TIMESTAMP}, #{item.updateBy,jdbcType=VARCHAR}, #{item.priceTypeCode,jdbcType=VARCHAR},
      #{item.priceTypeName,jdbcType=VARCHAR}, #{item.priceValue,jdbcType=BIGINT}, #{item.effectiveTime,jdbcType=TIMESTAMP},
      #{item.stopTime,jdbcType=TIMESTAMP}, #{item.skuCode,jdbcType=VARCHAR}, #{item.skuName,jdbcType=VARCHAR},
      #{item.supplierCode,jdbcType=VARCHAR}, #{item.supplierName,jdbcType=VARCHAR})
    </foreach>
  </insert>
  <insert id="insertList" parameterType="java.util.List" >
    insert into product_sku_price (add_points_value, gross_profit_margin_value,
    del_flag, create_time, create_by,
    update_time, update_by, price_type_code,
    price_type_name, price_value, effective_time,
    stop_time, sku_code, sku_name,
    apply_code, supplier_code, supplier_name
    )
    values
    <foreach collection="list" item="item" index="index" separator=",">
      (#{item.addPointsValue,jdbcType=BIGINT}, #{item.grossProfitMarginValue,jdbcType=BIGINT},
      #{item.delFlag,jdbcType=TINYINT}, #{item.createTime,jdbcType=TIMESTAMP}, #{item.createBy,jdbcType=VARCHAR},
      #{item.updateTime,jdbcType=TIMESTAMP}, #{item.updateBy,jdbcType=VARCHAR}, #{item.priceTypeCode,jdbcType=VARCHAR},
      #{item.priceTypeName,jdbcType=VARCHAR}, #{item.priceValue,jdbcType=BIGINT}, #{item.effectiveTime,jdbcType=TIMESTAMP},
      #{item.stopTime,jdbcType=TIMESTAMP}, #{item.skuCode,jdbcType=VARCHAR}, #{item.skuName,jdbcType=VARCHAR},
      #{item.applyCode,jdbcType=VARCHAR}, #{item.supplierCode,jdbcType=VARCHAR}, #{item.supplierName,jdbcType=VARCHAR}
      )
    </foreach>
  </insert>
  <insert id="insertApplyList" parameterType="java.util.List">
    insert into apply_product_sku_price (add_points_value, gross_profit_margin_value,
    del_flag, create_time, create_by,
    update_time, update_by, price_type_code,
    price_type_name, price_value, effective_time,
    stop_time, sku_code, sku_name,
    apply_code, supplier_code, supplier_name,
    is_default, tax_rate)
    values
    <foreach collection="list" item="item" index="index" separator=",">
      (#{item.addPointsValue,jdbcType=BIGINT}, #{item.grossProfitMarginValue,jdbcType=BIGINT},
      #{item.delFlag,jdbcType=TINYINT}, #{item.createTime,jdbcType=TIMESTAMP}, #{item.createBy,jdbcType=VARCHAR},
      #{item.updateTime,jdbcType=TIMESTAMP}, #{item.updateBy,jdbcType=VARCHAR}, #{item.priceTypeCode,jdbcType=VARCHAR},
      #{item.priceTypeName,jdbcType=VARCHAR}, #{item.priceValue,jdbcType=BIGINT}, #{item.effectiveTime,jdbcType=TIMESTAMP},
      #{item.stopTime,jdbcType=TIMESTAMP}, #{item.skuCode,jdbcType=VARCHAR}, #{item.skuName,jdbcType=VARCHAR},
      #{item.applyCode,jdbcType=VARCHAR}, #{item.supplierCode,jdbcType=VARCHAR}, #{item.supplierName,jdbcType=VARCHAR},
      #{item.isDefault,jdbcType=TINYINT}, #{item.taxRate,jdbcType=BIGINT})
    </foreach>
  </insert>
  <select id="getDraft" parameterType="java.lang.String" resultMap="com.aiqin.bms.scmp.api.product.mapper.ProductSkuPriceDraftMapper.BaseResultMap">
    SELECT * FROM product_sku_price_draft WHERE del_flag=0 AND de sku_code=#{skuCode,jdbcType=VARCHAR}
  </select>
  <select id="getInfo" parameterType="java.lang.String" resultMap="com.aiqin.bms.scmp.api.product.mapper.ProductSkuPriceMapper.BaseResultMap">
    SELECT * FROM product_sku_price WHERE sku_code=#{skuCode,jdbcType=VARCHAR}
  </select>
  <select id="getDrafts" parameterType="java.util.List" resultMap="com.aiqin.bms.scmp.api.product.mapper.ProductSkuPriceDraftMapper.BaseResultMap">
    SELECT * FROM product_sku_price_draft WHERE del_flag=0 AND sku_code IN
    <foreach collection="productSkus" item="item" open="(" separator="," close=")">
      #{item.skuCode,jdbcType=VARCHAR}
    </foreach>
  </select>
  <delete id="deleteDrafts" parameterType="java.util.List" >
    DELETE FROM product_sku_price_draft WHERE sku_code IN
    <foreach collection="productSkus" item="item" open="(" separator="," close=")">
      #{item.skuCode,jdbcType=VARCHAR}
    </foreach>
  </delete>
  <delete id="deleteList" parameterType="java.lang.String">
    DELETE FROM product_sku_price WHERE sku_code #{skuCode,jdbcType=VARCHAR}
  </delete>
  <select id="getPriceSku" resultType="com.aiqin.bms.scmp.api.product.domain.response.variableprice.PriceDetailedResponse">
    SELECT
    psk.sku_code as skuCode,
    psk.sku_name as skuName,
    psk.procurement_section_code as procurementSectionCode,
    psk.procurement_section_name as procurementSectionName,
    psp.price_type_code as priceTypeCode,
    psp.price_type_name as priceTypeName,
    psp.price_value as taxAmount,
    psp.tax_rate as taxRate,
    psp.price_value-(psp.price_value*FORMAT(psp.tax_rate*0.01,2))as nonTaxAmount,
    str_to_date(psk.selection_effective_start_time,'%Y-%m-%d %H:%i:%s') as takeEffectTime,
    str_to_date(psk.selection_effective_end_time,'%Y-%m-%d %H:%i:%s') as failureTime,
    psk.product_category_code as productCategoryCode,
    psk.product_category_name as productCategoryName,
    psk.product_brand_code as productBrandCode,
    psk.product_brand_name as productBrandName,
    psk.product_property_code as productPropertyCode,
    psk.product_property_name as productPropertyName,
    psp.supplier_name as supplierName,
    psp.supplier_code as supplierCode,
    psp.is_default as isDefault,
    psk.update_by as updateBy,
    psk.update_time as updateTime
    FROM product_sku_price psp
    LEFT JOIN product_sku psk ON psk.sku_code=psp.sku_code
    WHERE psp.del_flag=0
    <if test="priceSkuId!=null">
     AND psp.id= #{priceSkuId,jdbcType=BIGINT}
     </if>
  </select>
  <update id="updateList"  parameterType="java.util.List">
  <foreach collection="list" item="item" index="index" open="" close="" separator=";">
    update product_sku_price
    <set>
      <if test="#{item.newPrice}!= null">
        price_value=#{item.newPrice,jdbcType=BIGINT},
      </if>
      <if test="#{item.updateBy}!= null">
        update_by=#{item.updateBy,jdbcType=VARCHAR},
      </if>
    </set>
    where sku_code = #{item.skuCode}
    AND price_type_code=#{item.priceTypeCode}
  </foreach>
  </update>
  <select id="getApply" parameterType="java.lang.String" resultMap="com.aiqin.bms.scmp.api.product.mapper.ApplyProductSkuPriceMapper.BaseResultMap">
    SELECT * from apply_product_sku_price where sku_code=#{skuCode,jdbcType=VARCHAR}
    and apply_code = #{applyCode}
  </select>
  <select id="getApplys" parameterType="java.util.List" resultMap="com.aiqin.bms.scmp.api.product.mapper.ApplyProductSkuPriceMapper.BaseResultMap">
    SELECT * from apply_product_sku_price where sku_code in
    <foreach collection="applyProductSkus" item="item" open="(" separator="," close=")">
      #{item.skuCode,jdbcType=VARCHAR}
    </foreach>
  </select>
  <!--<select id="getInfoCode" parameterType="java.util.List" resultMap="com.aiqin.bms.scmp.api.product.mapper.ProductSkuPriceMapper.BaseResultMap">-->
      <!--SELECT * FROM product_sku_price WHERE del_flag=0-->
    <!--<if test="skuCodes!=null and skuCodes.size()>0">-->
      <!--AND sku_code in-->
    <!--<foreach collection="skuCodes" item="item" open="(" separator="," close=")">-->
      <!--#{item,jdbcType=VARCHAR}-->
    <!--</foreach>-->
    <!--</if>-->
    <!--<if test="priceTypeCode!=null and priceTypeCode!=''">-->
      <!--AND price_type_code=#{priceTypeCode,jdbcType=VARCHAR}-->
    <!--</if>-->
  <!--</select>-->
</mapper>